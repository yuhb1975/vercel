const fs = require('fs');
const path = require('path');

exports.version = 2;

exports.build = async ({ workPath, config = {} }) => {
  const name = typeof config.name === 'string' ? config.name : 'service';
  const buildOutputPath = path.join(workPath, '.vercel', 'output');

  await fs.promises.mkdir(buildOutputPath, { recursive: true });
  await fs.promises.writeFile(
    path.join(buildOutputPath, 'config.json'),
    JSON.stringify(
      {
        version: 3,
        routes: [{ src: `^/${name}/?$`, dest: `/${name}` }],
        overrides: {
          [`static/${name}.txt`]: {
            path: `static/${name}.txt`,
          },
        },
      },
      null,
      2
    )
  );

  return {
    buildOutputPath,
    buildOutputVersion: 3,
  };
};
